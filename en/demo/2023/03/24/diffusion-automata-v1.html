<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Diffusion Automata v1</title><!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v3.9.3" />
<meta property="og:title" content="Diffusion Automata v1" />
<meta name="author" content="Joel Schutz" />
<meta property="og:locale" content="en" />
<meta name="description" content="The goal for this Automata is to simulate the diffusion of a liquid on a solid medium, like soil, sand, etc. It was created as a prototype of a underground water diffusion for my game." />
<meta property="og:description" content="The goal for this Automata is to simulate the diffusion of a liquid on a solid medium, like soil, sand, etc. It was created as a prototype of a underground water diffusion for my game." />
<link rel="canonical" href="https://github.com/devlog/en/demo/2023/03/24/diffusion-automata-v1.html" />
<meta property="og:url" content="https://github.com/devlog/en/demo/2023/03/24/diffusion-automata-v1.html" />
<meta property="og:site_name" content="Joel’s Dev Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-03-24T01:04:38+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Diffusion Automata v1" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Joel Schutz"},"dateModified":"2023-03-24T01:04:38+00:00","datePublished":"2023-03-24T01:04:38+00:00","description":"The goal for this Automata is to simulate the diffusion of a liquid on a solid medium, like soil, sand, etc. It was created as a prototype of a underground water diffusion for my game.","headline":"Diffusion Automata v1","mainEntityOfPage":{"@type":"WebPage","@id":"https://github.com/devlog/en/demo/2023/03/24/diffusion-automata-v1.html"},"url":"https://github.com/devlog/en/demo/2023/03/24/diffusion-automata-v1.html"}</script>
<!-- End Jekyll SEO tag -->
<link type="application/atom+xml" rel="alternate" href="https://github.com/devlog/en/feed.xml" title="Joel's Dev Blog" /><link rel="shortcut icon" type="image/x-icon" href="/devlog/en/favicon.ico" />
  <link rel="stylesheet" href="/devlog/en/assets/css/main.css" />
  <script type="text/javascript" async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>
</head><body a="dark">
    <main class="page-content" aria-label="Content">
      <div class="w">
        <a href="/devlog/en/">../</a><article>
  <p class="post-meta">
    <time datetime="2023-03-24 01:04:38 +0000">Mar-24-2023</time>
  </p><p class="languages">
    
        
            
    <a href="/devlog/demo/2023/03/24/diffusion-automata-v1.html">pt-br</a>
            
        
    
        
    en
        
    
    </p><p>
    <iframe frameborder="0" scrolling="no" src="/devlog/assets/wasm/Automata/automata.html" srcdoc="
    <!DOCTYPE html>
      <script src=&quot;/devlog/assets/wasm/wasm_exec.js&quot;></script>
      <script>
      // Polyfill
      if (!WebAssembly.instantiateStreaming) {
          WebAssembly.instantiateStreaming = async (resp, importObject) => {
              const source = await (await resp).arrayBuffer();
              return await WebAssembly.instantiate(source, importObject);
          };
      }
      
      const go = new Go();
      WebAssembly.instantiateStreaming(fetch(&quot;/devlog/assets/wasm/Automata/automata.v1.wasm&quot;), go.importObject).then(result => {
          go.run(result.instance);
      });
      </script>" width="100%" height="480"></iframe>
  </p><h1>Diffusion Automata v1</h1>

  <p>The goal for this Automata is to simulate the diffusion of
a liquid on a solid medium, like soil, sand, etc. It was created
as a prototype of a underground water diffusion for my game.</p>

<p>As will notice, there isn’t much complexity in this code, that’s the magic
of this kind of algorithm, we can use simple rules to create complex
behavior. Here, we simulate the interaction between liquids ans solids
over time and space using basic arithmetic</p>

<p>Our board will be represented by a 2d array of vectors, this is just
for convenience since we can easily group the two relevant values:</p>

<ul>
  <li>Humidity
    <ul>
      <li>The amount of liquid within the cell</li>
    </ul>
  </li>
  <li>Impermeability
    <ul>
      <li>The resistance of the cell to the movement of liquid trough it</li>
    </ul>
  </li>
</ul>

<p>The fields <code class="language-plaintext highlighter-rouge">Rocks</code> and <code class="language-plaintext highlighter-rouge">Rain</code> just represent cells that are totally impermeable
or sources of humidity, respectively.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">HumidityBoard</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">values</span>      <span class="p">[][]</span><span class="n">mgl32</span><span class="o">.</span><span class="n">Vec2</span> <span class="c">// [humidity, impermeability]</span>
	<span class="n">Rocks</span><span class="p">,</span> <span class="n">Rain</span> <span class="p">[][]</span><span class="kt">bool</span>
	<span class="n">hvrX</span><span class="p">,</span> <span class="n">hvrY</span>  <span class="kt">int</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The logic to determine the humidity of a cell is simples, since the liquid
converges to a uniform distribution over time for all the space, we assume
that the new value of humidity of a cell is just the mean between it and
their neighbors values. For simplicity, we only count 4 neighbors as the
diagram below, where <code class="language-plaintext highlighter-rouge">v0</code> is the current cell:</p>

<table>
  <tbody>
    <tr>
      <td> </td>
      <td>v3</td>
      <td> </td>
    </tr>
    <tr>
      <td>v1</td>
      <td>v0</td>
      <td>v2</td>
    </tr>
    <tr>
      <td> </td>
      <td>v4</td>
      <td> </td>
    </tr>
  </tbody>
</table>

<p>To include permeability properties, we use a weighted mean where each
factor is defined by that cell impermeability. The catch is that we use
the inverse(1/value) for neighboring cells, that way we achieve the effect
of a highly impermeable cell resisting either losing or gaining humidity.
Then we clamp to new value to a max of 1024.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="p">(</span><span class="n">ba</span> <span class="o">*</span><span class="n">HumidityBoard</span><span class="p">)</span> <span class="n">Update</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="c">// Store the initial state as reference</span>
	<span class="n">m0</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([][]</span><span class="n">mgl32</span><span class="o">.</span><span class="n">Vec2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ba</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
	<span class="nb">copy</span><span class="p">(</span><span class="n">m0</span><span class="p">,</span> <span class="n">ba</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

	<span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">row</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">ba</span><span class="o">.</span><span class="n">values</span> <span class="p">{</span>
		<span class="k">for</span> <span class="n">y</span><span class="p">,</span> <span class="n">v0</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">row</span> <span class="p">{</span>
			<span class="c">// Skip the calculations for humidity sources and impermeable cell</span>
			<span class="k">if</span> <span class="n">ba</span><span class="o">.</span><span class="n">Rain</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">]</span> <span class="o">||</span> <span class="n">v0</span><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">MaxFloat32</span><span class="o">/</span><span class="m">5</span><span class="p">)</span><span class="o">*</span><span class="m">4</span> <span class="p">{</span>
				<span class="k">continue</span>
			<span class="p">}</span>

			<span class="c">// Assume that borders are dry and impermeable</span>
			<span class="n">v1</span> <span class="o">:=</span> <span class="n">mgl32</span><span class="o">.</span><span class="n">Vec2</span><span class="p">{</span><span class="m">0</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">MaxFloat32</span><span class="p">}</span>
			<span class="n">v2</span> <span class="o">:=</span> <span class="n">mgl32</span><span class="o">.</span><span class="n">Vec2</span><span class="p">{</span><span class="m">0</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">MaxFloat32</span><span class="p">}</span>
			<span class="n">v3</span> <span class="o">:=</span> <span class="n">mgl32</span><span class="o">.</span><span class="n">Vec2</span><span class="p">{</span><span class="m">0</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">MaxFloat32</span><span class="p">}</span>
			<span class="n">v4</span> <span class="o">:=</span> <span class="n">mgl32</span><span class="o">.</span><span class="n">Vec2</span><span class="p">{</span><span class="m">0</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">MaxFloat32</span><span class="p">}</span>

			<span class="c">// Verify if neighbor exists and use their value</span>
			<span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="m">0</span> <span class="p">{</span>
				<span class="n">v1</span> <span class="o">=</span> <span class="n">m0</span><span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="m">1</span><span class="p">][</span><span class="n">y</span><span class="p">]</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">m0</span><span class="p">)</span><span class="o">-</span><span class="m">1</span> <span class="p">{</span>
				<span class="n">v2</span> <span class="o">=</span> <span class="n">m0</span><span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="m">1</span><span class="p">][</span><span class="n">y</span><span class="p">]</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="n">y</span> <span class="o">&gt;</span> <span class="m">0</span> <span class="p">{</span>
				<span class="n">v3</span> <span class="o">=</span> <span class="n">m0</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="o">-</span><span class="m">1</span><span class="p">]</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">m0</span><span class="p">)</span><span class="o">-</span><span class="m">1</span> <span class="p">{</span>
				<span class="n">v4</span> <span class="o">=</span> <span class="n">m0</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="o">+</span><span class="m">1</span><span class="p">]</span>
			<span class="p">}</span>

			<span class="c">// Calculate the weighted mean</span>
			<span class="n">r</span> <span class="o">:=</span> <span class="p">((</span><span class="n">v0</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">v0</span><span class="p">[</span><span class="m">1</span><span class="p">]))</span> <span class="o">+</span> <span class="p">(</span><span class="n">v1</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">v1</span><span class="p">[</span><span class="m">1</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="n">v2</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">v2</span><span class="p">[</span><span class="m">1</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="n">v3</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">v3</span><span class="p">[</span><span class="m">1</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="n">v4</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">v4</span><span class="p">[</span><span class="m">1</span><span class="p">]))</span> <span class="o">/</span> <span class="p">(</span><span class="n">v0</span><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="m">1</span> <span class="o">/</span> <span class="n">v1</span><span class="p">[</span><span class="m">1</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="m">1</span> <span class="o">/</span> <span class="n">v2</span><span class="p">[</span><span class="m">1</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="m">1</span> <span class="o">/</span> <span class="n">v3</span><span class="p">[</span><span class="m">1</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="m">1</span> <span class="o">/</span> <span class="n">v4</span><span class="p">[</span><span class="m">1</span><span class="p">]))</span>

			<span class="c">// Clamp values to 1024</span>
			<span class="k">if</span> <span class="n">r</span> <span class="o">&gt;</span> <span class="m">1024</span> <span class="p">{</span>
				<span class="n">r</span> <span class="o">=</span> <span class="m">1024</span>
			<span class="p">}</span>

			<span class="c">// Updates board with new humidity value</span>
			<span class="n">ba</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">][</span><span class="m">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The final result is not perfect, there are parameters that are not accounted like velocity
and density of the liquid, but it’s sufficient for our porpoises. Another limitation of this
method is lack of conservation of mass. As the simulation evolves the humidity spontaneously
drops, which is physically impossible.</p>

<p>As stated previous, this is a prototype and limitation as this are not necessarily concerns
for games development. Keep in mind that this algorithm is synchronous, but it’s totally
possible to paralelize it.</p>

<hr />

<p>Hope you liked this material and that it was helpful, I’m still working on this website and demos to help people that are interested in programming things beyond the web development niche. If you have any question or suggestion, please contact me through <a href="https://github.com/joelschutz">GitHub</a> or <a href="mailto:joelsschutz@yahoo.com.br">e-mail</a>.
<img src="https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExNDU3M2ZhZmUxZDQ4NGM3NGY1YjJlMzFkZmNkYTA2NmFhZGExNGFiNCZjdD1n/htebeL9yH0ZI9K47Jo/giphy.gif" alt="thank you!" /></p>

</article>
      </div>
    </main><script data-goatcounter="https://joelschutz.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>

<noscript>
  <img src="https://joelschutz.goatcounter.com/count?p=/test-img">
</noscript>
  </body>
</html>